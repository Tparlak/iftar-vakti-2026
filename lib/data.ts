// Türkiye şehirleri ve koordinatları (81 İl)
export const CITIES = [
    { name: "Adana", lat: 36.9914, lng: 35.3308, id: "adana" },
    { name: "Adıyaman", lat: 37.7644, lng: 38.2762, id: "adiyaman" },
    { name: "Afyonkarahisar", lat: 38.7507, lng: 30.5567, id: "afyonkarahisar" },
    { name: "Ağrı", lat: 39.7225, lng: 43.0531, id: "agri" },
    { name: "Amasya", lat: 40.6499, lng: 35.8353, id: "amasya" },
    { name: "Ankara", lat: 39.9334, lng: 32.8597, id: "ankara" },
    { name: "Antalya", lat: 36.8969, lng: 30.7133, id: "antalya" },
    { name: "Artvin", lat: 41.1828, lng: 41.8183, id: "artvin" },
    { name: "Aydın", lat: 37.8444, lng: 27.8458, id: "aydin" },
    { name: "Balıkesir", lat: 39.6484, lng: 27.8826, id: "balikesir" },
    { name: "Bilecik", lat: 40.1419, lng: 29.9793, id: "bilecik" },
    { name: "Bingöl", lat: 38.8847, lng: 40.4939, id: "bingol" },
    { name: "Bitlis", lat: 38.4006, lng: 42.1095, id: "bitlis" },
    { name: "Bolu", lat: 40.735, lng: 31.6061, id: "bolu" },
    { name: "Burdur", lat: 37.7203, lng: 30.2908, id: "burdur" },
    { name: "Bursa", lat: 40.1826, lng: 29.0665, id: "bursa" },
    { name: "Çanakkale", lat: 40.1553, lng: 26.4142, id: "canakkale" },
    { name: "Çankırı", lat: 40.6013, lng: 33.6134, id: "cankiri" },
    { name: "Çorum", lat: 40.5506, lng: 34.9556, id: "corum" },
    { name: "Denizli", lat: 37.7765, lng: 29.0864, id: "denizli" },
    { name: "Diyarbakır", lat: 37.9144, lng: 40.2306, id: "diyarbakir" },
    { name: "Edirne", lat: 41.6768, lng: 26.557, id: "edirne" },
    { name: "Elazığ", lat: 38.681, lng: 39.2264, id: "elazig" },
    { name: "Erzincan", lat: 39.75, lng: 39.5, id: "erzincan" },
    { name: "Erzurum", lat: 39.9043, lng: 41.2679, id: "erzurum" },
    { name: "Eskişehir", lat: 39.7767, lng: 30.5206, id: "eskisehir" },
    { name: "Gaziantep", lat: 37.0662, lng: 37.3833, id: "gaziantep" },
    { name: "Giresun", lat: 40.9128, lng: 38.3895, id: "giresun" },
    { name: "Gümüşhane", lat: 40.4608, lng: 39.4814, id: "gumushane" },
    { name: "Hakkari", lat: 37.5744, lng: 43.7408, id: "hakkari" },
    { name: "Hatay", lat: 36.4018, lng: 36.3498, id: "hatay" },
    { name: "Isparta", lat: 37.7648, lng: 30.5566, id: "isparta" },
    { name: "Mersin", lat: 36.8121, lng: 34.6415, id: "mersin" },
    { name: "İstanbul", lat: 41.0082, lng: 28.9784, id: "istanbul" },
    { name: "İzmir", lat: 38.4192, lng: 27.1287, id: "izmir" },
    { name: "Kars", lat: 40.6013, lng: 43.0975, id: "kars" },
    { name: "Kastamonu", lat: 41.3811, lng: 33.7753, id: "kastamonu" },
    { name: "Kayseri", lat: 38.7312, lng: 35.4787, id: "kayseri" },
    { name: "Kırklareli", lat: 41.7333, lng: 27.2167, id: "kirklareli" },
    { name: "Kırşehir", lat: 39.1425, lng: 34.1709, id: "kirsehir" },
    { name: "Kocaeli", lat: 40.8533, lng: 29.8815, id: "kocaeli" },
    { name: "Konya", lat: 37.8714, lng: 32.4847, id: "konya" },
    { name: "Kütahya", lat: 39.4167, lng: 29.9833, id: "kutahya" },
    { name: "Malatya", lat: 38.3552, lng: 38.3093, id: "malatya" },
    { name: "Manisa", lat: 38.6191, lng: 27.4289, id: "manisa" },
    { name: "Kahramanmaraş", lat: 37.5858, lng: 36.9371, id: "kahramanmaras" },
    { name: "Mardin", lat: 37.3129, lng: 40.7339, id: "mardin" },
    { name: "Muğla", lat: 37.2153, lng: 28.3636, id: "mugla" },
    { name: "Muş", lat: 38.7432, lng: 41.5064, id: "mus" },
    { name: "Nevşehir", lat: 38.6244, lng: 34.7144, id: "nevsehir" },
    { name: "Niğde", lat: 37.9667, lng: 34.6833, id: "nigde" },
    { name: "Ordu", lat: 40.9839, lng: 37.8764, id: "ordu" },
    { name: "Rize", lat: 41.0201, lng: 40.5234, id: "rize" },
    { name: "Sakarya", lat: 40.7569, lng: 30.3789, id: "sakarya" },
    { name: "Samsun", lat: 41.2928, lng: 36.3313, id: "samsun" },
    { name: "Siirt", lat: 37.9274, lng: 41.946, id: "siirt" },
    { name: "Sinop", lat: 42.0268, lng: 35.1511, id: "sinop" },
    { name: "Sivas", lat: 39.7477, lng: 37.0179, id: "sivas" },
    { name: "Tekirdağ", lat: 40.9833, lng: 27.5167, id: "tekirdag" },
    { name: "Tokat", lat: 40.3167, lng: 36.55, id: "tokat" },
    { name: "Trabzon", lat: 41.0015, lng: 39.7178, id: "trabzon" },
    { name: "Tunceli", lat: 39.1079, lng: 39.5401, id: "tunceli" },
    { name: "Şanlıurfa", lat: 37.1591, lng: 38.7969, id: "sanliurfa" },
    { name: "Uşak", lat: 38.6823, lng: 29.4082, id: "usak" },
    { name: "Van", lat: 38.4891, lng: 43.3833, id: "van" },
    { name: "Yozgat", lat: 39.8181, lng: 34.8147, id: "yozgat" },
    { name: "Zonguldak", lat: 41.4511, lng: 31.7944, id: "zonguldak" },
    { name: "Aksaray", lat: 38.3687, lng: 34.037, id: "aksaray" },
    { name: "Bayburt", lat: 40.2552, lng: 40.2249, id: "bayburt" },
    { name: "Karaman", lat: 37.1759, lng: 33.2287, id: "karaman" },
    { name: "Kırıkkale", lat: 39.8468, lng: 33.5153, id: "kirikkale" },
    { name: "Batman", lat: 37.8812, lng: 41.1351, id: "batman" },
    { name: "Şırnak", lat: 37.5164, lng: 42.4611, id: "sirnak" },
    { name: "Bartın", lat: 41.6371, lng: 32.3338, id: "bartin" },
    { name: "Ardahan", lat: 41.1105, lng: 42.7022, id: "ardahan" },
    { name: "Iğdır", lat: 39.9167, lng: 44.0333, id: "igdir" },
    { name: "Yalova", lat: 40.6551, lng: 29.2769, id: "yalova" },
    { name: "Karabük", lat: 41.1992, lng: 32.6273, id: "karabuk" },
    { name: "Kilis", lat: 36.7184, lng: 37.1212, id: "kilis" },
    { name: "Osmaniye", lat: 37.0742, lng: 36.2472, id: "osmaniye" },
    { name: "Düzce", lat: 40.8438, lng: 31.1565, id: "duzce" },
];

export interface PrayerTimes {
    imsak: string;
    gunes: string;
    ogle: string;
    ikindi: string;
    aksam: string;
    yatsi: string;
}

// Aladhan API parameters
const COUNTRY = "Turkey";
const METHOD = 13; // Diyanet İşleri Başkanlığı

// Gerçek API'den vakitleri çek (Tek gün için)
export async function fetchPrayerTimes(cityName: string): Promise<PrayerTimes> {
    try {
        const response = await fetch(
            `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(cityName)}&country=${COUNTRY}&method=${METHOD}`
        );
        const data = await response.json();
        if (data.code === 200) {
            const t = data.data.timings;
            return {
                imsak: t.Fajr,
                gunes: t.Sunrise,
                ogle: t.Dhuhr,
                ikindi: t.Asr,
                aksam: t.Maghrib,
                yatsi: t.Isha,
            };
        }
        throw new Error("API hatası");
    } catch (error) {
        console.error("Vakitler alınamadı, yerel hesaplama kullanılıyor:", error);
        const cityData = CITIES.find(c => c.name === cityName) || CITIES.find(c => c.name === "İstanbul")!;
        return calculatePrayerTimes(new Date(), cityData.lat, cityData.lng);
    }
}

// Aylık vakitleri çek (Imsakiye için)
export async function fetchMonthlyPrayerTimes(cityName: string, year: number, month: number): Promise<any[]> {
    try {
        const response = await fetch(
            `https://api.aladhan.com/v1/calendarByCity/${year}/${month}?city=${encodeURIComponent(cityName)}&country=${COUNTRY}&method=${METHOD}`
        );
        const data = await response.json();
        if (data.code === 200) {
            return data.data;
        }
        return [];
    } catch (error) {
        console.error("Aylık vakitler alınamadı:", error);
        return [];
    }
}

// Namaz vakti hesaplama (yedek/fallback)
export function calculatePrayerTimes(date: Date, lat: number, lng: number): PrayerTimes {
    const dayOfYear = Math.floor(
        (date.getTime() - new Date(date.getFullYear(), 0, 0).getTime()) / 86400000
    );

    const seasonalOffset = Math.sin(((dayOfYear - 80) * 2 * Math.PI) / 365) * 1.5;
    const latOffset = (lat - 39) * 0.05;

    const baseImsak = 5.5 - seasonalOffset - latOffset;
    const baseFajr = baseImsak + 0.33;
    const baseSunrise = baseFajr + 1.25;
    const baseDhuhr = 12.15 + (29 - lng) / 15;
    const baseAsr = baseDhuhr + 3.75 + seasonalOffset * 0.3;
    const baseMaghrib = baseDhuhr + 5.5 + seasonalOffset;
    const baseIsha = baseMaghrib + 1.5;

    const formatTime = (t: number) => {
        const hours = Math.floor(t) % 24;
        const minutes = Math.floor((t - Math.floor(t)) * 60) % 60;
        return `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}`;
    };

    return {
        imsak: formatTime(baseImsak),
        gunes: formatTime(baseSunrise),
        ogle: formatTime(baseDhuhr),
        ikindi: formatTime(baseAsr),
        aksam: formatTime(baseMaghrib),
        yatsi: formatTime(baseIsha),
    };
}

// Ramazan 2026 tarihleri
export const RAMAZAN_START = new Date(2026, 1, 17); // 17 Şubat 2026
export const RAMAZAN_END = new Date(2026, 2, 18);   // 18 Mart 2026

export function getRamazanDay(date: Date): number {
    const diff = date.getTime() - RAMAZAN_START.getTime();
    const day = Math.floor(diff / 86400000) + 1;
    if (day < 1 || day > 30) return 0;
    return day;
}

export function getDaysUntilRamazan(date: Date): number {
    const diff = RAMAZAN_START.getTime() - date.getTime();
    const days = Math.ceil(diff / 86400000);
    return Math.max(0, days);
}

export function isRamazan(date: Date): boolean {
    return date >= RAMAZAN_START && date <= RAMAZAN_END;
}

// Kıble yönü hesaplama
export function calculateQibla(lat: number, lng: number): number {
    const kaabaLat = 21.4225;
    const kaabaLng = 39.8262;

    const latRad = (lat * Math.PI) / 180;
    const kaabaLatRad = (kaabaLat * Math.PI) / 180;
    const lngDiff = ((kaabaLng - lng) * Math.PI) / 180;

    const x = Math.sin(lngDiff);
    const y = Math.cos(latRad) * Math.tan(kaabaLatRad) - Math.sin(latRad) * Math.cos(lngDiff);

    let qibla = (Math.atan2(x, y) * 180) / Math.PI;
    if (qibla < 0) qibla += 360;

    return qibla;
}

// Günlük İlerleme (Oruç Süresi: İmsak - Akşam)
export function getDayProgress(prayerTimes: PrayerTimes): number {
    if (!prayerTimes.imsak || prayerTimes.imsak === "--:--") return 0;

    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();

    const [imsakH, imsakM] = prayerTimes.imsak.split(":").map(Number);
    const [aksamH, aksamM] = prayerTimes.aksam.split(":").map(Number);

    const imsakMinutes = imsakH * 60 + imsakM;
    const aksamMinutes = aksamH * 60 + aksamM;

    if (currentMinutes < imsakMinutes) return 0;
    if (currentMinutes > aksamMinutes) return 100;

    return Math.round(
        ((currentMinutes - imsakMinutes) / (aksamMinutes - imsakMinutes)) * 100
    );
}

// Hangi vakit aktif?
export function getCurrentPrayer(prayerTimes: PrayerTimes): string {
    if (!prayerTimes.imsak || prayerTimes.imsak === "--:--") return "";

    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();

    const times = [
        { name: "İmsak", time: prayerTimes.imsak },
        { name: "Güneş", time: prayerTimes.gunes },
        { name: "Öğle", time: prayerTimes.ogle },
        { name: "İkindi", time: prayerTimes.ikindi },
        { name: "Akşam", time: prayerTimes.aksam },
        { name: "Yatsı", time: prayerTimes.yatsi },
    ];

    for (let i = times.length - 1; i >= 0; i--) {
        const [h, m] = times[i].time.split(":").map(Number);
        if (currentMinutes >= h * 60 + m) {
            return times[i].name;
        }
    }
    return "Yatsı";
}

// Sonraki vakit
export function getNextPrayer(prayerTimes: PrayerTimes): { name: string; time: string; remaining: string } {
    if (!prayerTimes.imsak || prayerTimes.imsak === "--:--") return { name: "...", time: "", remaining: "..." };

    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();

    const times = [
        { name: "İmsak", time: prayerTimes.imsak },
        { name: "Güneş", time: prayerTimes.gunes },
        { name: "Öğle", time: prayerTimes.ogle },
        { name: "İkindi", time: prayerTimes.ikindi },
        { name: "Akşam", time: prayerTimes.aksam },
        { name: "Yatsı", time: prayerTimes.yatsi },
    ];

    for (let i = 0; i < times.length; i++) {
        const [h, m] = times[i].time.split(":").map(Number);
        const prayerMinutes = h * 60 + m;
        if (prayerMinutes > currentMinutes) {
            const diff = prayerMinutes - currentMinutes;
            const hours = Math.floor(diff / 60);
            const mins = diff % 60;
            return {
                name: times[i].name,
                time: times[i].time,
                remaining: hours > 0 ? `${hours} sa ${mins} dk` : `${mins} dk`,
            };
        }
    }

    return { name: "İmsak", time: prayerTimes.imsak, remaining: "Yarın" };
}
